---
layout: mypost
title: 消息队列相关的问题
categories: [消息队列]
---

## 为什么引入消息队列？ 2021-06-28
1. 异步化，举个例子，下单操作一般完整的操作链比较长，下单->扣库存->生成订单->下单通知，还有可能包括针对下单的营销活动等等。这一系列操作
如果全部同步完成才算下单完成，可能非常耗时，影响用户体验。引入消息队列优化用户体检。
2. 解耦，还拿订单数据来说，订单生成的通知或者其它业务系统对订单数据进行分析，那么其它业务系统通过 MQ 自己接收订单信息，需要就接收，不需要就不接受，订单只负责吧数据推送到 MQ。
3. 削峰，防止大量的请求直接到数据库。举个例子，直播环境下的狂赞，不限制点赞的数量，如果直播间人气比较火的话，短时可能会有大量的点赞数据请求保存到数据库中，为了缓解数据库的并发压力，
所有的请求转到 MQ，然后消费端匀速消费。
   
## 引入消息队列得缺点？ 2021-07-07
1. 系统得整体可用性降低。
2. 系统得复杂度提高，业务流程更长。
3. 一致性问题。

## 如何保证消息队列的高可用？ 2021-07-07
RabbitMQ：镜像集群模式，每个节点都存储完整的队列元数据，某个节点宕机对整体的服务没有影响。缺点就是不支持分布式。

## 如何保证消息的顺序性？ 2021-07-07
1. 业务层面拆分 queue，然后每个队列一个 consumer，缺点是可能 queue 会比较多。

## 如何保证消息的可靠性？ 2021-06-28
1. 保证消息不会丢失。
2. 保证消息不会重复消费。

## 如何处理消息丢失的问题？ 2021-07-07
RabbitMQ:
1. 生产者提交到 MQ 失败，网络等原因。
   - 消息回调处理成功或者失败（失败或者入库或者怎么处理都行）。
2. MQ 接收到，但是还没持久化就返回 ack，接着 MQ 挂掉丢失。
   - 配置 MQ 在持久化消息之后在回复 ack。
3. 消费者自己收到消息，还没消费自动回复 ack。
   - 关闭自动 ack，改为手动 ack，在处理完业务逻辑之后进行手动 ack。

## 那些情况会出现重复消费的问题？ 2021-06
1. 生产者发送消息到 MQ 之后，MQ 的响应较慢，触发重试机制消息重发。
2. 消费者消费逻辑处理完之后，ack 过程中 MQ 挂掉，MQ 恢复之后认为该消息还未消费，再次推送。
3. 消费者消费逻辑处理完之后，未来得及 ack，消费者自己挂掉了，重启之后再次消费消息。

## 消息的幂等性如何保证？ 2021-07-06
1. 每次成功消费之后记录消费的消息，下次消费的时候先查询是否已经消费过。
2. 业务校验。消息中附带唯一 ID，业务逻辑做幂等处理。

## MySQL 逻辑处理一部分后提交消息，消息提交失败数据库的事务怎么处理？ 2021-07-06
1. 不重要消息直接丢掉。
2. 重要的消息，但是 MQ 可能挂掉了，全局回滚。
3. 重要的消息，可能是网络抖动导致，重试，多次失败消息入库，排查原因。

## 消息积压问题排查？处理？ 2021-07-06
1. 不重要的消息修改消费代码，直接丢弃处理。
2. 如果是消费者性能问题，临时扩容。
3. 如果是消费者系统问题，修复消费者。

## 消息提交失败怎么处理？ 2021-07-06
